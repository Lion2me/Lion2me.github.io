---

layout: post
title: 쿠버네티스 잘 사용하기
date: 2024-06-30 18:05:23 +0900
category: DE
use_math: true
tags:
- 쿠버네티스
- k8s
- kubernetes


---

# 서론

이 글은 쿠버네티스로 구성되어있는 사내 서비스 클러스터를 활용하던 중 Ingress 및 여러 설정 등에 대한 이해도 부족으로 업무가 지연 된 경험이 있기에 그 부분을 바로잡고자 공부하기위해 적습니다.

# 쿠버네티스란?

클러스터 환경에서 컨테이너화 된 애플리케이션을 자동으로 배포하고 확장 및 관리하는데에 필요한 요소를 자동화하는 오픈소스 플랫폼입니다. 여러 서버로 구성 된 클러스터 환경을 구축하는 것에 쿠버네티스를 사용하면 로드밸런싱, 네트워크, 스토리지, 모니터링 등 시스템 운영에 필수적인 여러 컴포넌트를 쉽게 구축 할 수 있습니다.

쿠버네티스는 일반적으로 yaml 파일과 같은 형식의 파일로 구성합니다. 이렇듯 모든 작업을 소스코드로 관리하면 운영 시스템에 적용하기 전 검토에 유용하고, 사전 검증도 편해집니다.

또한, 쿠버네티스는 '의도된 상태'를 기준으로 관리합니다. 최초 의도한 상태와 현재 진행중인 상태를 쿠버네티스 컨트롤러가 자동으로 끊임없이 확인( go 언어의 watch )하며 차이점이 발생하면 현재 상태를 자동으로 의도 된 상태로 변경합니다. 예를들면 Nginx 서버가 갑자기 예상치 않게 종료되면 쿠버네티스는 곧바로 새로운 pod를 생성합니다.

클러스터의 전체 상태를 지속적으로 체크하여 자원의 할당이나 물리적인 리소스 등을 조절하고 활용합니다.

# 쿠버네티스의 주요 오브젝트

쿠버네티스의 주요 오브젝트로는 Pod, Deployment, Namespace 등이 있습니다. 이런 오브젝트등은 쿠버네티스 API 서버로 생성하는 영속성을 가지는 모든 실체로 애플리케이션을 실행하고 애플리케이션에 필요한 추가 리소스를 지정하고 고가용성 관련 설정 등 모든 쿠버네티스 작업은 다양한 오브젝트와 그 옵션의 조합으로 실행합니다.

## Pod란?

Pod는 쿠버네티스 환경에서 컨테이너 애플리케이션을 실행하는 기본 단위입니다. Pod는 다른 Pod와 구분되는 고유한 네트워크와 스토리지를 가지고 확장 시 Pod 단위로 증성합니다. Pod는 각자 고유의 IP와 볼륨을 사용합니다. 별도의 설정이 없는 한 호스트 노드의 /var/lib/containers/{pod이름}의 경로에 디렉토리를 만들고 해당 공간을 마운트합니다.

### Pod의 주요 옵션

#### resource

- cpu ( request, limit )
	- 해당 Pod에 할당 할 CPU 리소스를 지정 할 수 있습니다.
		- request : 적어도 이 정도의 리소스가 있어야 Pod를 생성합니다.
		- limit : 이 리소스 량을 넘어서면 Pod가 죽습니다. 최대 사용 가능량입니다.
- Memory ( request, limit )
	- 해당 Pod에 할당 할 Memory 리소스를 지정 할 수 있습니다.
		- request : 적어도 이 정도의 리소스가 있어야 Pod를 생성합니다.
		- limit : 이 리소스 량을 넘어서면 Pod가 죽습니다. 최대 사용 가능량입니다.

#### anti-affinity(affinity)

affinity는 pod가 어떤 노드에 생성 될 것 인지에 대해서 설정 할 수 있는 설정 값 입니다. 이러한 역할을 하는 옵션은 가장 대중적으로 NodeSelector가 있고 실제로 간단한 노드 지정은 이 옵션을 사용해도 문제가 없습니다. 하지만 affinity는 더 유연한 노드 선택 기능을 제공합니다.

- 특정 노드에는 Pod가 생성되지 않도록 ( Anti-affinity )
	- 혹은 특정 노드에는 가급적 Pod가 생성되지 않도록 ( + prefered )
- 특정 노드에만 Pod가 생성 될 수 있도록 ( affinity )
	- 혹은 가급적 특정 노드에 Pod가 생성 될 수 있도록 ( + prefered )
- 더 다양한 플러그인 제공 ( addedAffinity )

## Deployment란?

Deployment는 Pod가 어떻게 배포 될 것인지에 대한 방법을 정의하는 오브젝트입니다. Pod의 갯수, 이미지 종류, 배포 방법등을 한번에 정리하여 원하는 형식으로 Pod가 배포 될 수 있도록 도와줍니다.

Deployment에서는 replica를 지정 할 수 있는데, 이 경우 기존의 Pod를 제거(delete)하더라도 그 숫자를 유지하기 위해 저절로 새로운 Pod를 생성합니다.

즉 Pod에 설정 할 리소스를 Deployment에 적어놓고 많은 Pod를 쉽게 배포 할 수 있습니다.

## Namespace란?

Namespace는 클러스터를 구분하는 가상 클러스터의 단위입니다. 같은 Namespace에서는 같은 이름의 오브젝트를 만들지 못합니다. 이러한 Namespace은 애플리케이션을 구분하는 단위로 사용합니다. 예를들면 웹서버, 데이터베이스, 레디스 등의 애플리케이션 단위로 나눌 수 있습니다. 그리고 RBAC과 같은 제어 설정을 통해 Namespace 단위로 각 개발자가 접근 할 수 있는 영역을 나눌 수 있습니다.

하지만 Namespace는 결국 클러스터를 가상으로 구분하는 방식이기에 네트워크가 구분되어 있지 않습니다. 즉, 임의의 Namespace에서 다른 Namespace로 네트워크 통신은 가능합니다.

## Service란?

Service는 Pod간 네트워크 연결을 담당하는 리소스입니다. 이 부분이 제가 어려움을 겪은 지점에 대한 해결책이 될 수 있을 것 같습니다.

Service가 필요한 이유은 Kubernetes는 기본적으로 확장 혹은 장애 발생시 유동적으로 Pod를 생성 및 제거하여 서비스의 안정도를 높이는 작업을 합니다. 이 과정에서 각 Pod가 할당받는 내부 IP 주소는 계속해서 변하게 되며, 관련 환경변수 등을 수동으로 관리하면 매우 어려운 작업이 됩니다. 여기서 Service는 각 Pod간의 연결을 유동적으로 관리해줍니다.

기본적으로 다음과 같은 특징을 가집니다.

- 다이나믹하게 종료되고 생성되는 파드를 자동으로 발견합니다.
- 변경이 잦은 IP 주소가 아닌 지속 가능한 도메인 레코드를 기반으로 쿠버네티스 서비스 이름을 이용해 통신합니다.
- 노드 내 실행 중인 여러 Pod로 부하를 분산하는 로드밸런싱 기능을 자체적으로 지원합니다.


Service 문서
- https://kubernetes.io/ko/docs/concepts/services-networking/service/

위 문서 중 특정 pod의 네트워크를 외부에 노출하기 위해 사용 할 만한 정보도 있는 것 같습니다.
- https://kubernetes.io/ko/docs/concepts/services-networking/service/#type-nodeport

## Ingress란?

REST API의 느낌으로 경로마다 다른 Service로 전달되도록 할 수 있는 라우터 느낌의 리소스입니다.

Ingress 문서
https://kubernetes.io/ko/docs/concepts/services-networking/ingress/

다른 추가적인 내용보다 좋은 예시와 설명이 있어서 공식 문서만 적겠습니다. 이번에 해결하지 못한 문제로 외부 망과 내부 망의 통신에 관련 된 내용이 있었는데, 이 부분에서 별도의 Ingress 경로에 VPC에서 내부와 Internet Gateway로 통할 수 있는 VPC로 설정하여 통신을 시도하면 가능하지 않을까 생각중입니다.

언젠가 해결해야 할 문제라 일단 적어놓겠습니다.

예상하기로는 Service의 nodeport를 별도로 설정 한 pod를 띄우고 해당 pod의 HTTP 포트 접근으로 Ingress 를 만들어 노출 및 라우팅하면 원하는 서비스를 만들 수 있지 않을까 생각됩니다.

## ConfigMap란?

ConfigMap은 개별 애플리케이션의 환경변수를 설정합니다. 필수적으로 사용해야하는 오브젝트는 아니지만, Pod나 다른 오브젝트에서 불러와서 사용 할 수 있는 범용적인 환경변수 등을 지정해놓고 쉽게 사용 할 수 있습니다.



## 작성중